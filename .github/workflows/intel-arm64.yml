name: Build EntrySafe macOS (Intel + Apple Silicon) - cv2 fixed (no recursion + config)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.10"
  OPENCV_VERSION: "4.9.0.80"
  PYINSTALLER_VERSION: "6.3.0"
  PYINSTALLER_HOOKS_VERSION: "2024.2"
  NUMPY_VERSION: "<2.0.0"

jobs:
  build-macos-intel:
    name: Build macOS Intel (x86_64)
    runs-on: macos-15-intel

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install deps (Intel)
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip uninstall -y opencv-python-headless opencv-contrib-python opencv-contrib-python-headless opencv-python numpy || true
          pip install "setuptools==69.0.3" "wheel==0.42.0"
          pip install "numpy${{ env.NUMPY_VERSION }}"
          pip install "pyinstaller==${{ env.PYINSTALLER_VERSION }}" "pyinstaller-hooks-contrib==${{ env.PYINSTALLER_HOOKS_VERSION }}"
          pip install "opencv-python==${{ env.OPENCV_VERSION }}"
          pip install face_recognition face_recognition_models PyQt6 psycopg2-binary
          python -c "import cv2; import os; print('cv2:', cv2.__version__, 'file:', cv2.__file__); print('Has VideoCapture?', hasattr(cv2,'VideoCapture'))"

      - name: Create config.json template
        run: |
          set -euo pipefail
          cat > config.json << 'EOF'
          {
            "DB_HOST": "CHANGE_ME",
            "DB_PORT": 5432,
            "DB_NAME": "CHANGE_ME",
            "DB_USER": "CHANGE_ME",
            "DB_PASS": "CHANGE_ME"
          }
          EOF

      - name: Check icon exists
        run: |
          set -euo pipefail
          test -f "assets/icons/appLogo.icns" || (echo "ERROR: assets/icons/appLogo.icns missing" && exit 1)

      - name: Prepare OpenCV config files (IMPORTANT)
        run: |
          set -euo pipefail
          rm -rf cv2_runtime
          mkdir -p cv2_runtime
          python - << 'PY'
          import cv2, os, shutil, glob
          pkg_dir = os.path.dirname(cv2.__file__)  # .../site-packages/cv2
          patterns = [
            "config.py",
            "config-*.py",
            "load_config_py3.py",
            "load_config_py2.py",
            "*.xml",
          ]
          copied = []
          for pat in patterns:
            for src in glob.glob(os.path.join(pkg_dir, pat)):
              dst = os.path.join("cv2_runtime", os.path.basename(src))
              shutil.copy2(src, dst)
              copied.append(dst)
          print("cv2 pkg dir:", pkg_dir)
          print("copied:", copied)
          if not any(os.path.basename(x) == "config.py" for x in copied):
            raise SystemExit("ERROR: cv2 config.py not found/copied")
          PY

      - name: Create runtime hook (remove '.' + dedupe Frameworks; safe)
        run: |
          set -euo pipefail
          cat > runtime_hook.py << 'EOF'
          import os, sys

          # Always start from a safe working directory (avoid running inside app folder)
          try:
              os.chdir(os.path.expanduser("~"))
          except Exception:
              pass

          # Remove ONLY the dangerous entries that cause cv2 recursion
          # and dedupe duplicated Frameworks paths.
          new_path = []
          seen = set()

          for p in list(sys.path):
              if p in ("", "."):
                  continue

              np = os.path.normpath(p)
              if np in seen:
                  continue
              seen.add(np)
              new_path.append(p)

          sys.path[:] = new_path
          EOF

      - name: Build app (PyInstaller) - Intel
        run: |
          set -euo pipefail
          pyinstaller --noconfirm --clean --windowed --onedir --name "EntrySafe" \
            --icon assets/icons/appLogo.icns \
            --osx-bundle-identifier com.entrysafe.app \
            --paths . \
            --runtime-hook runtime_hook.py \
            --hidden-import cv2 \
            --hidden-import cv2.cv2 \
            --add-data "cv2_runtime:cv2" \
            --hidden-import views \
            --hidden-import utils \
            --hidden-import utils.paths \
            --hidden-import face_recognition \
            --hidden-import face_recognition_models \
            --collect-data face_recognition_models \
            --collect-submodules views \
            --collect-submodules utils \
            --add-data "assets:assets" \
            --add-data "ui:ui" \
            --add-data "config.json:." \
            main.py

      - name: Locate app bundle (Intel)
        run: |
          set -euo pipefail
          echo "==== dist tree (debug) ===="
          find dist -maxdepth 6 -print || true
          if [ -d "dist/EntrySafe/EntrySafe.app" ]; then
            APP_PATH="dist/EntrySafe/EntrySafe.app"
          elif [ -d "dist/EntrySafe.app" ]; then
            APP_PATH="dist/EntrySafe.app"
          else
            APP_PATH="$(find dist -maxdepth 6 -name "EntrySafe.app" -type d | head -n 1 || true)"
          fi
          test -d "$APP_PATH" || (echo "ERROR: EntrySafe.app not found" && exit 1)
          echo "APP_PATH=$APP_PATH" >> "$GITHUB_ENV"
          echo "Found APP_PATH=$APP_PATH"

      - name: Remove ONLY duplicate Resources/cv2 (keep Frameworks/cv2)
        run: |
          set -euo pipefail
          if [ -d "$APP_PATH/Contents/Resources/cv2" ]; then
            echo "Removing duplicate: $APP_PATH/Contents/Resources/cv2"
            rm -rf "$APP_PATH/Contents/Resources/cv2"
          else
            echo "No Resources/cv2 found (good)."
          fi

      - name: Bundle libintl for Intel (prevents @rpath/libintl.8.dylib crash)
        run: |
          set -euo pipefail
          brew update >/dev/null 2>&1 || true
          brew install gettext >/dev/null 2>&1 || true
          GETTEXT_PREFIX="$(brew --prefix gettext)"
          if [ -f "$GETTEXT_PREFIX/lib/libintl.8.dylib" ]; then
            cp -f "$GETTEXT_PREFIX/lib/libintl.8.dylib" "$APP_PATH/Contents/Frameworks/"
            echo "Copied libintl.8.dylib into Frameworks."
          fi
          if [ -f "$GETTEXT_PREFIX/lib/libiconv.2.dylib" ]; then
            cp -f "$GETTEXT_PREFIX/lib/libiconv.2.dylib" "$APP_PATH/Contents/Frameworks/"
            echo "Copied libiconv.2.dylib into Frameworks."
          fi

      - name: Add Camera/Mic usage strings (Intel)
        run: |
          set -euo pipefail
          PLIST="$APP_PATH/Contents/Info.plist"
          /usr/libexec/PlistBuddy -c "Add :NSCameraUsageDescription string 'EntrySafe needs camera access to scan and verify faces for security.'" "$PLIST" 2>/dev/null || \
          /usr/libexec/PlistBuddy -c "Set :NSCameraUsageDescription 'EntrySafe needs camera access to scan and verify faces for security.'" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :NSMicrophoneUsageDescription string 'EntrySafe may access the microphone if required by the camera device.'" "$PLIST" 2>/dev/null || \
          /usr/libexec/PlistBuddy -c "Set :NSMicrophoneUsageDescription 'EntrySafe may access the microphone if required by the camera device.'" "$PLIST"

      - name: Remove broken symlinks inside app (fix codesign ENOENT)
        run: |
          set -euo pipefail
          while IFS= read -r -d '' link; do
            target="$(readlink "$link" || true)"
            dir="$(dirname "$link")"
            if [[ "$target" != /* ]]; then
              resolved="$dir/$target"
            else
              resolved="$target"
            fi
            if [ -n "$target" ] && [ ! -e "$resolved" ]; then
              echo "BROKEN: $link -> $target"
              rm -f "$link"
            fi
          done < <(find "$APP_PATH" -type l -print0)

      - name: Ad-hoc sign (Intel) - sign nested dylibs incl. symlinks
        run: |
          set -euo pipefail
          echo "Signing: $APP_PATH"
          test -d "$APP_PATH" || (echo "ERROR: EntrySafe.app not found" && exit 1)

          # Clean any previous signature
          codesign --remove-signature "$APP_PATH" 2>/dev/null || true

          # 1) Sign EVERY dylib/so under Frameworks (including symlinks)
          if [ -d "$APP_PATH/Contents/Frameworks" ]; then
            while IFS= read -r -d '' f; do
              # If it's a symlink, sign the resolved target (codesign on symlink is flaky)
              if [ -L "$f" ]; then
                tgt="$(python - << 'PY'
          import os,sys
          p=sys.argv[1]
          print(os.path.realpath(p))
          PY
          "$f")"
                          echo "Signing (symlink target): $tgt"
                          codesign --force --timestamp=none --sign - "$tgt"
                        else
                          echo "Signing: $f"
                          codesign --force --timestamp=none --sign - "$f"
                        fi
                      done < <(find "$APP_PATH/Contents/Frameworks" \( -type f -o -type l \) \
                                \( -name "*.dylib" -o -name "*.so" \) -print0)
                    fi
          
                    # 2) Sign the main executable
                    codesign --force --timestamp=none --sign - "$APP_PATH/Contents/MacOS/EntrySafe"
          
                    # 3) Sign the app bundle last
                    codesign --force --timestamp=none --sign - "$APP_PATH"
          
                    # Verify (no --deep; deep can hide problems instead of fixing them)
                    codesign --verify --verbose=4 "$APP_PATH"

      - name: Package Intel release
        run: |
          set -euo pipefail
          rm -rf "EntrySafe-Intel"
          mkdir -p "EntrySafe-Intel/uploads/guardians"
          cp -R "$APP_PATH" "EntrySafe-Intel/"
          cp "config.json" "EntrySafe-Intel/"
          cat > "EntrySafe-Intel/launch.command" << 'EOF'
          #!/bin/bash
          cd "$(dirname "$0")"
          ./EntrySafe.app/Contents/MacOS/EntrySafe
          EOF
          chmod +x "EntrySafe-Intel/launch.command"
          ditto -c -k --sequesterRsrc --keepParent "EntrySafe-Intel" "EntrySafe-macOS-Intel.zip"

      - name: Upload Intel artifact
        uses: actions/upload-artifact@v4
        with:
          name: EntrySafe-macOS-Intel
          path: EntrySafe-macOS-Intel.zip

  build-macos-arm64:
    name: Build macOS Apple Silicon (arm64)
    runs-on: macos-15

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install deps (ARM64)
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip uninstall -y opencv-python-headless opencv-contrib-python opencv-contrib-python-headless opencv-python numpy || true
          pip install "setuptools==69.0.3" "wheel==0.42.0"
          pip install "numpy${{ env.NUMPY_VERSION }}"
          pip install "pyinstaller==${{ env.PYTHON_VERSION }}" || true
          pip install "pyinstaller==${{ env.PYINSTALLER_VERSION }}" "pyinstaller-hooks-contrib==${{ env.PYINSTALLER_HOOKS_VERSION }}"
          pip install "opencv-python==${{ env.OPENCV_VERSION }}"
          pip install face_recognition face_recognition_models PyQt6 psycopg2-binary
          python -c "import cv2; import os; print('cv2:', cv2.__version__, 'file:', cv2.__file__); print('Has VideoCapture?', hasattr(cv2,'VideoCapture'))"

      - name: Create config.json template
        run: |
          set -euo pipefail
          cat > config.json << 'EOF'
          {
            "DB_HOST": "CHANGE_ME",
            "DB_PORT": 5432,
            "DB_NAME": "CHANGE_ME",
            "DB_USER": "CHANGE_ME",
            "DB_PASS": "CHANGE_ME"
          }
          EOF

      - name: Check icon exists
        run: |
          set -euo pipefail
          test -f "assets/icons/appLogo.icns" || (echo "ERROR: assets/icons/appLogo.icns missing" && exit 1)

      - name: Prepare OpenCV config files (IMPORTANT)
        run: |
          set -euo pipefail
          rm -rf cv2_runtime
          mkdir -p cv2_runtime
          python - << 'PY'
          import cv2, os, shutil, glob
          pkg_dir = os.path.dirname(cv2.__file__)
          patterns = [
            "config.py",
            "config-*.py",
            "load_config_py3.py",
            "load_config_py2.py",
            "*.xml",
          ]
          copied = []
          for pat in patterns:
            for src in glob.glob(os.path.join(pkg_dir, pat)):
              dst = os.path.join("cv2_runtime", os.path.basename(src))
              shutil.copy2(src, dst)
              copied.append(dst)
          print("cv2 pkg dir:", pkg_dir)
          print("copied:", copied)
          if not any(os.path.basename(x) == "config.py" for x in copied):
            raise SystemExit("ERROR: cv2 config.py not found/copied")
          PY

      - name: Create runtime hook (remove '.' + dedupe Frameworks; safe)
        run: |
          set -euo pipefail
          cat > runtime_hook.py << 'EOF'
          import os, sys
          try:
              os.chdir(os.path.expanduser("~"))
          except Exception:
              pass

          new_path = []
          seen = set()

          for p in list(sys.path):
              if p in ("", "."):
                  continue
              np = os.path.normpath(p)
              if np in seen:
                  continue
              seen.add(np)
              new_path.append(p)

          sys.path[:] = new_path
          EOF

      - name: Build app (PyInstaller) - ARM64
        run: |
          set -euo pipefail
          pyinstaller --noconfirm --clean --windowed --onedir --name "EntrySafe" \
            --icon assets/icons/appLogo.icns \
            --osx-bundle-identifier com.entrysafe.app \
            --paths . \
            --runtime-hook runtime_hook.py \
            --hidden-import cv2 \
            --hidden-import cv2.cv2 \
            --add-data "cv2_runtime:cv2" \
            --hidden-import views \
            --hidden-import utils \
            --hidden-import utils.paths \
            --hidden-import face_recognition \
            --hidden-import face_recognition_models \
            --collect-data face_recognition_models \
            --collect-submodules views \
            --collect-submodules utils \
            --add-data "assets:assets" \
            --add-data "ui:ui" \
            --add-data "config.json:." \
            main.py

      - name: Locate app bundle (ARM64)
        run: |
          set -euo pipefail
          echo "==== dist tree (debug) ===="
          find dist -maxdepth 6 -print || true
          if [ -d "dist/EntrySafe/EntrySafe.app" ]; then
            APP_PATH="dist/EntrySafe/EntrySafe.app"
          elif [ -d "dist/EntrySafe.app" ]; then
            APP_PATH="dist/EntrySafe.app"
          else
            APP_PATH="$(find dist -maxdepth 6 -name "EntrySafe.app" -type d | head -n 1 || true)"
          fi
          test -d "$APP_PATH" || (echo "ERROR: EntrySafe.app not found" && exit 1)
          echo "APP_PATH=$APP_PATH" >> "$GITHUB_ENV"
          echo "Found APP_PATH=$APP_PATH"

      - name: Remove ONLY duplicate Resources/cv2 (keep Frameworks/cv2)
        run: |
          set -euo pipefail
          if [ -d "$APP_PATH/Contents/Resources/cv2" ]; then
            echo "Removing duplicate: $APP_PATH/Contents/Resources/cv2"
            rm -rf "$APP_PATH/Contents/Resources/cv2"
          else
            echo "No Resources/cv2 found (good)."
          fi

      - name: Add Camera/Mic usage strings (ARM64)
        run: |
          set -euo pipefail
          PLIST="$APP_PATH/Contents/Info.plist"
          /usr/libexec/PlistBuddy -c "Add :NSCameraUsageDescription string 'EntrySafe needs camera access to scan and verify faces for security.'" "$PLIST" 2>/dev/null || \
          /usr/libexec/PlistBuddy -c "Set :NSCameraUsageDescription 'EntrySafe needs camera access to scan and verify faces for security.'" "$PLIST"
          /usr/libexec/PlistBuddy -c "Add :NSMicrophoneUsageDescription string 'EntrySafe may access the microphone if required by the camera device.'" "$PLIST" 2>/dev/null || \
          /usr/libexec/PlistBuddy -c "Set :NSMicrophoneUsageDescription 'EntrySafe may access the microphone if required by the camera device.'" "$PLIST"

      - name: Remove broken symlinks inside app (fix codesign ENOENT)
        run: |
          set -euo pipefail
          while IFS= read -r -d '' link; do
            target="$(readlink "$link" || true)"
            dir="$(dirname "$link")"
            if [[ "$target" != /* ]]; then
              resolved="$dir/$target"
            else
              resolved="$target"
            fi
            if [ -n "$target" ] && [ ! -e "$resolved" ]; then
              echo "BROKEN: $link -> $target"
              rm -f "$link"
            fi
          done < <(find "$APP_PATH" -type l -print0)

      - name: Ad-hoc sign (ARM64)
        run: |
          set -euo pipefail
          codesign --remove-signature "$APP_PATH" 2>/dev/null || true
          codesign --force --timestamp=none --sign - "$APP_PATH/Contents/MacOS/EntrySafe"
          if [ -d "$APP_PATH/Contents/Frameworks" ]; then
            find "$APP_PATH/Contents/Frameworks" -type f \( -name "*.dylib" -o -name "*.so" \) -print0 \
              | xargs -0 -I{} codesign --force --timestamp=none --sign - "{}"
          fi
          codesign --force --timestamp=none --sign - "$APP_PATH"
          codesign --verify --verbose=4 "$APP_PATH"

      - name: Package ARM64 release
        run: |
          set -euo pipefail
          rm -rf "EntrySafe-ARM64"
          mkdir -p "EntrySafe-ARM64/uploads/guardians"
          cp -R "$APP_PATH" "EntrySafe-ARM64/"
          cp "config.json" "EntrySafe-ARM64/"
          cat > "EntrySafe-ARM64/launch.command" << 'EOF'
          #!/bin/bash
          cd "$(dirname "$0")"
          ./EntrySafe.app/Contents/MacOS/EntrySafe
          EOF
          chmod +x "EntrySafe-ARM64/launch.command"
          ditto -c -k --sequesterRsrc --keepParent "EntrySafe-ARM64" "EntrySafe-macOS-ARM64.zip"

      - name: Upload ARM64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: EntrySafe-macOS-ARM64
          path: EntrySafe-macOS-ARM64.zip
